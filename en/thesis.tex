%%% The main file. It contains definitions of basic parameters and includes all other parts.

%% Settings for single-side (simplex) printing
% Margins: left 40mm, right 25mm, top and bottom 25mm
% (but beware, LaTeX adds 1in implicitly)
\documentclass[12pt,a4paper]{report}
\setlength\textwidth{145mm}
\setlength\textheight{247mm}
\setlength\oddsidemargin{15mm}
\setlength\evensidemargin{15mm}
\setlength\topmargin{0mm}
\setlength\headsep{0mm}
\setlength\headheight{0mm}
% \openright makes the following text appear on a right-hand page
\let\openright=\clearpage

%% Settings for two-sided (duplex) printing
% \documentclass[12pt,a4paper,twoside,openright]{report}
% \setlength\textwidth{145mm}
% \setlength\textheight{247mm}
% \setlength\oddsidemargin{14.2mm}
% \setlength\evensidemargin{0mm}
% \setlength\topmargin{0mm}
% \setlength\headsep{0mm}
% \setlength\headheight{0mm}
% \let\openright=\cleardoublepage

%% Character encoding: usually latin2, cp1250 or utf8:
\usepackage[utf8]{inputenc}

%% Further useful packages (included in most LaTeX distributions)
\usepackage{amsmath}        % extensions for typesetting of math
\usepackage{amsfonts}       % math fonts
\usepackage{amsthm}         % theorems, definitions, etc.
\usepackage{bbding}         % various symbols (squares, asterisks, scissors, ...)
\usepackage{bm}             % boldface symbols (\bm)
\usepackage{graphicx}       % embedding of pictures
\usepackage{fancyvrb}       % improved verbatim environment
\usepackage[square,numbers]{natbib}         % citation style AUTHOR (YEAR), or AUTHOR [NUMBER]
\usepackage[nottoc]{tocbibind} % makes sure that bibliography and the lists
			    % of figures/tables are included in the table
			    % of contents
\usepackage{dcolumn}        % improved alignment of table columns
\usepackage{booktabs}       % improved horizontal lines in tables
\usepackage{paralist}       % improved enumerate and itemize
\usepackage[usenames]{xcolor}  % typesetting in color
\DeclareGraphicsExtensions{.pdf,.png,.jpg}
\graphicspath{ {../img/} }
\usepackage{listings}
\usepackage{caption}

\usepackage{blindtext}
\lstset{columns=flexible}

%%% Basic information on the thesis

% Thesis title in English (exactly as in the formal assignment)
\def\ThesisTitle{Monitoring Tool for Distributed Java Applications}

% Author of the thesis
\def\ThesisAuthor{Bc. Jakub Háva}

% Year when the thesis is submitted
\def\YearSubmitted{2017}

% Name of the department or institute, where the work was officially assigned
% (according to the Organizational Structure of MFF UK in English,
% or a full name of a department outside MFF)
\def\Department{Department of Distributed and Dependable Systems}

% Is it a department (katedra), or an institute (ústav)?
\def\DeptType{Department}

% Thesis supervisor: name, surname and titles
\def\Supervisor{RNDr. Pavel Parízek, Ph.D}

% Supervisor's department (again according to Organizational structure of MFF)
\def\SupervisorsDepartment{Department of Distributed and Dependable Systems}

% Study programme and specialization
\def\StudyProgramme{Computer Science}
\def\StudyBranch{Software Systems}

% An optional dedication: you can thank whomever you wish (your supervisor,
% consultant, a person who lent the software, etc.)
\def\Dedication{%
I would like to thank my thesis supervisor Dr. Pavel Parízek for leading me throughout the whole thesis and willing to help with any concerns I've ever had. I would also like to thank H2O.ai for being able to write this thesis under their coordination, particularly to Dr. Michal Malohlava for providing very useful technical advice.
}

% Abstract (recommended length around 80-200 words; this is not a copy of your thesis assignment!)
\def\Abstract{%
The main goal of this thesis is to create a monitoring platform and library that can be used to monitor distributed Java-based applications. This work is inspired by Google Dapper and shares a concept called "Span" with it. Spans represents a small specific part of the computation and  are used to capture state among multiple communicating hosts. In order to be able to collect spans without recompiling the original application's code, instrumentation techniques are highly used in the thesis. The monitoring tool, which is called Distrace, consists of two parts: the native agent and instrumentation server. Users of this platform are supposed to extend the instrumentation server and specify the points in their application's code where new spans should be created and closed. In order to achieve high performance and affect the running application at least as possible, the instrumentation server is used for instrumenting the code. The tool is aimed to have a small foot-print on the monitored applications, should be easy to deploy and is transparent to target applications from the point of view of the final user.
}

% 3 to 5 keywords (recommended), each enclosed in curly braces
\def\Keywords{%
{monitoring}, {cluster}, {instrumentation}, {distributed systems}, {performance}
}

%% The hyperref package for clickable links in PDF and also for storing
%% metadata to PDF (including the table of contents).
\usepackage{url}
\def\UrlBreaks{\do\/\do-}


\usepackage[pdftex,unicode]{hyperref}   % Must follow all other packages
\hypersetup{breaklinks=true}
\hypersetup{pdftitle={\ThesisTitle}}
\hypersetup{pdfauthor={\ThesisAuthor}}
\hypersetup{pdfkeywords=\Keywords}
\hypersetup{urlcolor=blue}
% Definitions of macros (see description inside)
\include{macros}
% Title page and various mandatory informational pages
\begin{document}
\include{title}

%%% A page with automatically generated table of contents of the master thesis
\setcounter{tocdepth}{1}
\tableofcontents

%%% Each chapter is kept in a separate file
%%\include{preface}
\include{introduction}
\include{background}
\include{analysis}
\include{design}
\include{implementation}
\include{bigexample}
\include{Evaluation}
\include{Conclusion}

%%% Bibliography
\include{bibliography}
%%% Figures used in the thesis (consider if this is needed)
\listoffigures

%%% Tables used in the thesis (consider if this is needed)
%%% In mathematical theses, it could be better to move the list of tables to the beginning of the thesis.
%\listoftables

%%% Abbreviations used in the thesis, if any, including their explanation
%%% In mathematical theses, it could be better to move the list of abbreviations to the beginning of the thesis.


%%% Attachments to the master thesis, if any. Each attachment must be
%%% referred to at least once from the text of the thesis. Attachments
%%% are numbered.
%%%
%%% The printed version should preferably contain attachments, which can be
%%% read (additional tables and charts, supplementary text, examples of
%%% program output, etc.). The electronic version is more suited for attachments
%%% which will likely be used in an electronic form rather than read (program
%%% source code, data files, interactive charts, etc.). Electronic attachments
%%% should be uploaded to SIS and optionally also included in the thesis on a~CD/DVD.

\chapwithtoc{Attachments}
\begin{enumerate}
	\item Attachment 1: CD with the source codes of the Distrace tool.
	\item Attachment 2: List of examples available in Docker and instructions on how to run them.
	\item Attachment 3: Instructions on how to build and run
	\item Attachment 4: Native agent arguments
	\end{enumerate}
\openright

\setcounter{page}{1}
\chapter*{Attachment 2: List of Examples}
The source code of the thesis contains several examples. They can be run manually by first compiling the sources and then starting using the provided scripts. The examples are also available in the provided Docker machine. This docker machine contains all compile and run-time dependencies for the tool to be able to run and examples can be run in this machine as well.

The list of available examples:
\begin{enumerate}
	\item \textbf{DependencyInstrumentation} \newline
	This example just demonstrates the basic instrumentation functionality on dependent classes. It does not have any output do the user interface.
	\item \textbf{H2OSumMRTask} \newline
	This larger example demonstrates the tool on the H\textsubscript{2}O  machine learning platform. The cluster of three H\textsubscript{2}O  nodes is started and simple map-reduce tasks is executed within this cluster. The internals of map-reduce task are monitored and the associated spans are shown in the Zipkin user interface.
	\item \textbf{SingleJVMCallback} \newline
	This example demonstrates how the Distrace tool can be used to instrument and monitor the the callbacks. This example is using only a single JVM with multiple threads.
	\item \textbf{SingleJVMThread} \newline
	This example shows how thread can be instrumented in monitored. This example is running on a single JVM with multiple threads.
\end{enumerate}

\setcounter{page}{1}
\chapter*{Attachment 3: Building And Running}
To build both, the native agent and the core instrumentation server, the developer needs to obtain the Distrace tool sources\footnote{Distrace is available at \url{https://github.com/jakubhava/Distrace}.} and call \texttt{./gradlew build}\footnote{On Windows, \texttt{./gradlew.bat build}} command, which builds the tool and produces artifacts for the core instrumentation server and the native agent as well. The build process requires several dependencies to be available.

The instrumentation server requires Java 8 to be available. It has dependencies on several libraries, but these are downloaded automatically by the build process.

The native agent depends on several libraries which needs to be availalable on the system:
\begin{itemize}
	\item Boost-filesystem
	\item Boost-system
	\item Nanomsg
	\item Nanomsgxx
	\item Cmake
\end{itemize}
The last dependency is required to be able to build the native agent project. Any C++11 compliant compiler needs to be available as well.

Once the artifacts are build the user may extend the core instrumentation server with the instrumentation definition. The application can be further run using the following incantation:

\texttt{java -agentpath:"\$NATIVE\_AGENT\_LIB\_PATH=\$AGENT\_ARGS" -jar app.jar}

The \texttt{\$NATIVE\_AGENT\_LIB\_PATH} shell variable should point to the location of the native agent library and \texttt{\$AGENT\_ARGS} shell variable may contain any arguments passed to the native agent. The arguments are in the format \texttt{key=value} and are separated by the semicolon. Please see the Attachment 4 for the full list of available native agent arguments.

In order to be able to see the spans in the user interface, we need to start the Zipkin UI first. The user interface server may be started as: \texttt{java -jar zipkin.jar}\footnote{Zipkin Jar file may be downloaded at \url{https://github.com/openzipkin/zipkin} or is available at the attached CD.}.
\section{Running Docker Examples}
 In order to run this example without the need to set up all dependencies, the Docker container with this example is prepared. This container contains all Distrace dependencies and when started, is also automatically starts the Zipkin user interface on the default port. To run any example in Docker, Docker needs to be available, the projects source directory needs to be available as well\footnote{The sources are not actually needed for running the examples in docker, but the script which is used to start the docker machines is available there as well.} and the following script should be called: \texttt{./docker/run-test.sh}\footnote{On Windows, \texttt{./docker/run-test.cmd}}. 
 
Both these scripts expect a single argument representing the example name. When this argument is missing, the list of available examples is printed to the console.
\setcounter{page}{1}
\chapter*{Attachment 4 : Native Agent Arguments}
\setcounter{page}{1}
The native agent accepts several arguments which can be used to affect the agent behavior. In local instrumentation server mode, several arguments affect also the sever started from the agent. Available arguments are:
\begin{itemize}
	\item \textbf{instrumentor\_server\_jar} - specifies the path to the instrumentation server JAR. It is a mandatory argument in case the instrumentation server is supposed to run per each node of monitored application.
	\item \textbf{instrumentor\_server\_cp} - specifies the classpath for the instrumentation server. It can be used to add application specific classes on the server classpath which has the effect that the monitored application does not have to send to the server these classes if they need to be instrumented or if some class to be instrumented depends on them.
	\item \textbf{instrumentor\_main\_class} - specifies the main entry point for the instrumentation server. It is a required argument in case of local instrumentation server mode.
	\item \textbf{connection\_str} - specifies the type of connection between native agent and the instrumentation server. It is a mandatory argument in shared instrumentation server mode in which case the value is in format \texttt{tcp://ip:port} where ip:port is address of the instrumentation server. Otherwise, the agent and server communicates via inter-process communication and the argument can be set in format \texttt{ipc://identifier} where identifier specifies the name of pipe in case of Windows and name of the file used for IPC in case of Unix. However this value is set automatically at run-time if not explicitly specified as an argument.
	\item \textbf{log\_dir} - specifies the log directory for the agent and when running in local server mode, specifies the log directory for the server as well.
	\item \textbf{log\_level} - specifies the log level for the agent and when running in local server mode, specifies the log level for the server as well.
	\item \textbf{span\_exporter} - specifies the span exporter type. The value can be either \newline \texttt{directZipkin(ip:port)}, where \texttt{ip:port} is address of the Zipkin user interface or \texttt{disk(destination)}, where destination represents the output directory for the captured spans. 
	
	Custom span exporters are supported as well. In that case, the format of the value is fully qualified name of the span exporter with arguments in parenthesis, for example as \texttt{com.span.exporter(arguments)}
	\item \textbf{class\_output\_dir} - specifies the output directory for several helper classes received from the instrumentation server. This value is automatically set if not configured explicitly.
	\item \textbf{config\_file} - specifies path to a configuration file containing the agent configuration. It can contain all arguments mentioned above, except the configuration file argument. Argument entries in the configuration file are in the format \texttt{arg=value} and each entry is on a new line of the configuration file. 
\end{itemize}

\end{document}
